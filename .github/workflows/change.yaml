name: MyWorkflow

on:
  repository_dispatch:
    types: [change-sha]
    branches: [ test ]

jobs:
  change-image-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Debug - Verify files exist
        run: |
          echo "Current directory:"
          pwd
          echo "Repository structure:"
          ls -R
          echo "Checking for values files:"
          test -f environment/dev/local/values.yaml && echo "✓ local/values.yaml exists" || echo "✗ local/values.yaml NOT FOUND"
          test -f environment/dev/eks/values.yaml && echo "✓ eks/values.yaml exists" || echo "✗ eks/values.yaml NOT FOUND"
        
      - uses: OpsVerseIO/image-updater-action@0.1.0
        with:
          valueFile: 'environment/dev/local/values.yaml'
          branch: test
          targetBranch: test
          createPR: 'false'
          token: ${{ secrets.PAT }}
          description: Update All Images
          message: 'Update All Images' 
          title: 'Version Updates'
          changes: |
            {
              "backend.flaskBackend.imageTag": "${{ github.event.client_payload.sha }}",
              "frontend.reactFrontend.imageTag": "${{ github.event.client_payload.sha }}",
              "n8n.n8n.imageTag": "${{ github.event.client_payload.sha }}"
            }

      - uses: OpsVerseIO/image-updater-action@0.1.0
        with:
          valueFile: 'environment/dev/eks/values.yaml'
          branch: test
          targetBranch: test
          createPR: 'false'
          token: ${{ secrets.PAT }}
          description: Update All Images
          message: 'Update All Images' 
          title: 'Version Updates'
          changes: |
            {
              "backend.flaskBackend.imageTag": "${{ github.event.client_payload.sha }}",
              "frontend.reactFrontend.imageTag": "${{ github.event.client_payload.sha }}",
              "n8n.n8n.imageTag": "${{ github.event.client_payload.sha }}"
            }
          